name: Issue Triage with Goose

on:
  issues:
    types: [opened, edited]

jobs:
  triage:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Goose with pinned dependencies
      run: |
        pip install goose-ai "langfuse<3.0.0"
    
    - name: Create Goose configuration directory
      run: |
        mkdir -p ~/.config/goose
    
    - name: Generate Goose profiles configuration
      run: |
        cat > ~/.config/goose/profiles.yaml << 'EOF'
        default:
          provider: openai
          processor: openai/gpt-4o
          accelerator: openai/gpt-4o
          moderator: openai/gpt-4o
          api_base: https://openrouter.ai/api/v1
        EOF
    
    - name: Create instructions file
      run: |
        echo "# Triage Policy" > instructions.txt
        echo "" >> instructions.txt
        cat Day06/policies/triage_policy.md >> instructions.txt
        echo "" >> instructions.txt
        echo "# Issue to Triage" >> instructions.txt
        echo "" >> instructions.txt
        echo "**Title:** ${{ github.event.issue.title }}" >> instructions.txt
        echo "" >> instructions.txt
        echo "**Body:**" >> instructions.txt
        echo "${{ github.event.issue.body }}" >> instructions.txt
    
    - name: Run Goose triage
      env:
        PYTHON_KEYRING_BACKEND: keyring.backends.null.Keyring
        OPENAI_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        OPENAI_BASE_URL: https://openrouter.ai/api/v1
        OPENAI_API_BASE: https://openrouter.ai/api/v1
        GOOSE_PROVIDER: openai
        GOOSE_MODEL: anthropic/claude-3.5-sonnet
      run: |
        goose run instructions.txt
    
    - name: Clean up temporary files
      run: |
        rm -f instructions.txt
