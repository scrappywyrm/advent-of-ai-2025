name: Issue Triage with Direct API

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write
  contents: read
  repository-projects: read

jobs:
  triage:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        pip install requests
    
    - name: Create triage script
      run: |
        cat > triage.py << 'EOF'
        import os
        import json
        import requests
        import sys
        import re
        
        # Get environment variables
        api_key = os.environ.get('OPENROUTER_API_KEY')
        issue_title = os.environ.get('ISSUE_TITLE')
        issue_body = os.environ.get('ISSUE_BODY', '')
        
        if not api_key:
            print("Error: OPENROUTER_API_KEY not found")
            sys.exit(1)
        
        if not issue_title:
            print("Error: ISSUE_TITLE not found")
            sys.exit(1)
        
        # Prepare the prompt
        prompt = f"""Analyze this GitHub issue and provide a triage response.
        
        Issue Title: {issue_title}
        Issue Body: {issue_body}
        
        Please analyze this issue and return a JSON object with exactly these keys:
        - "label": one of "bug", "feature", "question", or "urgent"
        - "comment": a helpful response to the issue author
        
        Return valid JSON. Do not include unescaped newlines in the string values. Return only the JSON object, no other text."""
        
        # Make API request to OpenRouter
        headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        }
        
        data = {
            "model": "anthropic/claude-3.5-sonnet",
            "messages": [
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            "max_tokens": 1000
        }
        
        try:
            response = requests.post(
                "https://openrouter.ai/api/v1/chat/completions",
                headers=headers,
                json=data,
                timeout=60
            )
            response.raise_for_status()
            
            # Parse response
            result = response.json()
            content = result['choices'][0]['message']['content']
            
            # Clean up common LLM JSON errors
            # Find the JSON object
            match = re.search(r'\{.*\}', content, re.DOTALL)
            if match:
                json_str = match.group()
                # Attempt to clean unescaped newlines if json.loads fails
                try:
                    triage_result = json.loads(json_str)
                except json.JSONDecodeError:
                    # Fallback: simple manual extraction if JSON is broken
                    label = "bug" # Default
                    if "feature" in json_str.lower(): label = "feature"
                    elif "question" in json_str.lower(): label = "question"
                    elif "urgent" in json_str.lower(): label = "urgent"
                    
                    # extract comment roughly
                    try:
                        comment = json_str.split('"comment":')[1].strip().strip('"}').strip('"')
                        # Clean up common artifacts
                        comment = comment.replace('\\"', '"').replace('\\n', ' ')
                    except:
                        comment = "AI triage analysis completed."
                    
                    triage_result = {"label": label, "comment": comment}
            else:
                raise ValueError("No JSON found in response")
            
            # Write outputs
            with open('triage_output.json', 'w') as f:
                json.dump(triage_result, f)
            
            print(f"Triage completed successfully")
            print(f"Label: {triage_result.get('label', 'unknown')}")
            print(f"Comment: {triage_result.get('comment', 'No comment')}")
            
        except requests.exceptions.RequestException as e:
            print(f"API request failed: {e}")
            sys.exit(1)
        except (json.JSONDecodeError, KeyError) as e:
            print(f"Failed to parse response: {e}")
            print(f"Raw content: {content}")
            sys.exit(1)
        except Exception as e:
            print(f"Unexpected error: {e}")
            sys.exit(1)
        EOF
    
    - name: Run triage analysis
      env:
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_BODY: ${{ github.event.issue.body }}
      run: |
        python triage.py
    
    - name: Apply triage results
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Read triage results
        if [ -f "triage_output.json" ]; then
          LABEL=$(python -c "import json; print(json.load(open('triage_output.json'))['label'])")
          COMMENT=$(python -c "import json; print(json.load(open('triage_output.json'))['comment'])")
          
          echo "Applying label: $LABEL"
          echo "Adding comment: $COMMENT"
          
          # Try to create label if missing, but don't fail if we can't
          if ! gh label list | grep -q "$LABEL"; then
            echo "Label $LABEL not found. Attempting to create..."
            gh label create "$LABEL" --color FF0000 --description "Created by AI Triage" || echo "Warning: Could not create label. Permissions might be restricted."
          fi
          
          # Apply label (ignore error if label doesn't exist/couldn't be created)
          gh issue edit ${{ github.event.issue.number }} --add-label "$LABEL" || echo "Warning: Failed to apply label."
          
          # Always post the comment
          gh issue comment ${{ github.event.issue.number }} --body "$COMMENT"
          
          echo "Triage completed successfully"
        else
          echo "Error: triage_output.json not found"
          exit 1
        fi
    
    - name: Clean up temporary files
      run: |
        rm -f triage.py triage_output.json
